<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Informes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
        }
        h1 {
            font-size: 26px;
        }
        form {
            margin-bottom: 20px;
        }
        label {
            display: inline-block;
            margin-right: 10px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #999;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #eee;
        }
        button {
            padding: 6px 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>üìä Panel de Informes</h1>

    <form id="filtroForm" onsubmit="filtrarTareas(event)">
        <label>Desde: <input type="date" id="desde" required></label>
        <label>Hasta: <input type="date" id="hasta" required></label>
        <label>Responsable:
            <select id="responsable">
                <option value="">Todos</option>
                <option>Candelaria</option>
                <option>Natalia</option>
                <option>Soledad</option>
            </select>
        </label>
        <label>Estado:
            <select id="estado">
                <option value="">Todos</option>
                <option>Pendiente</option>
                <option>Completada</option>
            </select>
        </label>
        <button type="submit">üîç Filtrar</button>
        <button type="button" onclick="descargarExcel()">üì• Descargar Excel</button>
    </form>

    <div id="resultado"></div>

    <script>
        async function filtrarTareas(event) {
            event.preventDefault();

            const desde = document.getElementById("desde").value;
            const hasta = document.getElementById("hasta").value;
            const responsable = document.getElementById("responsable").value;
            const estado = document.getElementById("estado").value;

            const params = new URLSearchParams({ desde, hasta });
            if (responsable) params.append("responsable", responsable);
            if (estado) params.append("estado", estado);

            const res = await fetch(`/informes?${params.toString()}`);
            const tareas = await res.json();

            if (tareas.length === 0) {
                document.getElementById("resultado").innerHTML = "<p>No hay tareas que coincidan con los filtros seleccionados.</p>";
                return;
            }

            const tabla = `
                <table>
                    <tr>
                        <th>Fecha</th><th>Centro</th><th>Habit√°culo</th>
                        <th>Responsable</th><th>Estado</th><th>Comentarios</th>
                    </tr>
                    ${tareas.map(t => `
                        <tr>
                            <td>${t.fecha}</td>
                            <td>${t.centro}</td>
                            <td>${t.habitaculo}</td>
                            <td>${t.responsable}</td>
                            <td>${t.estado}</td>
                            <td>${t.comentarios}</td>
                        </tr>
                    `).join("")}
                </table>
                <p><strong>Total:</strong> ${tareas.length} tareas</p>
            `;
            document.getElementById("resultado").innerHTML = tabla;
        }

        function descargarExcel() {
            const desde = document.getElementById("desde").value;
            const hasta = document.getElementById("hasta").value;
            const responsable = document.getElementById("responsable").value;
            const estado = document.getElementById("estado").value;

            const params = new URLSearchParams({ desde, hasta });
            if (responsable) params.append("responsable", responsable);
            if (estado) params.append("estado", estado);

            window.open(`/exportar_excel_filtrado?${params.toString()}`, "_blank");
        }
    </script>
</body>
</html>
